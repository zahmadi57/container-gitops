name: Generate and Deploy Manifests

on:
  push:
    branches:
      - main
    paths:
      - 'students/week-*.yaml'

permissions:
  contents: write

jobs:
  generate-and-deploy:
    runs-on: container-gitops-runners  # Uses the ARC runner scale set
    name: Generate Manifests and Trigger ArgoCD

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install yq if needed
        run: |
          if ! command -v yq &> /dev/null; then
            echo "Installing yq to local bin..."
            mkdir -p ~/bin
            curl -sL https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o ~/bin/yq
            chmod +x ~/bin/yq
            echo "$HOME/bin" >> $GITHUB_PATH
          fi
          ~/bin/yq --version || yq --version

      - name: Generate Kubernetes manifests
        run: |
          echo "=== Generating Kubernetes manifests ==="
          chmod +x scripts/generate-manifests.sh
          ./scripts/generate-manifests.sh students/week-01.yaml
          echo "âœ… Manifests generated"

      - name: Commit generated manifests
        id: commit
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add manifests/generated/

          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "Auto-generate manifests from student submissions

            Generated by GitHub Actions
            Commit: ${{ github.sha }}

            Co-Authored-By: GitHub Actions <actions@github.com>"
            git push
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Manifests committed and pushed"
          fi

      - name: Trigger ArgoCD sync
        if: steps.commit.outputs.changed == 'true'
        continue-on-error: true
        run: |
          echo "=== Triggering ArgoCD sync ==="

          # Force ArgoCD to refresh and sync immediately
          kubectl -n argocd annotate application container-course-students \
            argocd.argoproj.io/refresh=normal --overwrite

          # Wait a few seconds for refresh
          sleep 5

          # Check sync status
          SYNC_STATUS=$(kubectl get application container-course-students -n argocd -o jsonpath='{.status.sync.status}')
          HEALTH_STATUS=$(kubectl get application container-course-students -n argocd -o jsonpath='{.status.health.status}')

          echo "ArgoCD Application Status:"
          echo "  Sync: $SYNC_STATUS"
          echo "  Health: $HEALTH_STATUS"

          # Get deployed students
          STUDENTS=$(kubectl get deployments -n container-course-week01 -l app=student-app -o jsonpath='{.items[*].metadata.labels.student}')
          echo "Deployed students: $STUDENTS"

          echo "âœ… ArgoCD sync triggered"

      - name: Post deployment summary
        if: steps.commit.outputs.changed == 'true'
        continue-on-error: true
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Manifests generated and ArgoCD sync triggered successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Student Deployments:**" >> $GITHUB_STEP_SUMMARY
          kubectl get deployments -n container-course-week01 -l app=student-app -o custom-columns=STUDENT:.metadata.labels.student,READY:.status.readyReplicas,IMAGE:.spec.template.spec.containers[0].image --no-headers >> $GITHUB_STEP_SUMMARY
